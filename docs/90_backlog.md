# User backlogs

## Backlog

### GC/アロケータ安定化（nslit × パターンラムダでの SEGV）
- 状態: Investigate
- 背景: GC 経路のみで `{ .Option = {...}; .map = (\~f -> \~opt -> (\None -> None | \(Some ~x) -> Some (~f ~x)) ~opt) }` などが SEGV。libc アロケータでは回避可能。
- 方針: Boehm GC との相互運用を監査（finalizer/再ハッシュ/初期化順序）。スキャナは libc に固定。恒久修正後に回避トグル撤去。
- 対応タスク
    - [ ] 最小再現ユニットテストを追加（GC 有効でのみ失敗していたケース）
    - [ ] `common/str.c` の finalizer と削除/再配置ロジックを監査・修正
    - [ ] GC 初期化順序の再検討（`GC_init()` の最小化/適正位置）
    - [ ] CI で GC/非 GC マトリクス実行を追加（`LAZYSCRIPT_USE_LIBC_ALLOC=1`）
    - [x] 一時回避トグルとデバッグフラグのドキュメント化（README）
- 受け入れ条件
    - [ ] GC 有効で全テスト green（新規再現テスト含む）
    - [ ] 回避トグル無しでも SEGV 再発なし（連続実行/負荷時も）

### クォート識別子（'Constr, .'Sym, ~'Var）のテスト/ドキュメント
- 状態: In Progress
- 目的: 追加済みの字句仕様を公式化し回帰を防止。
- 対応タスク
    - [ ] docs/01_lexing.md に単引用識別子とエスケープ仕様を追記
    - [x] 新規テスト（例: `t60_quoted_*`）を追加
    - [ ] 競合トークン順序の回帰チェックを CI に追加
- 受け入れ条件
    - [ ] 新規テストが安定通過し、既存構文と衝突しない

### ビルトインの戻り値統一（NULL 返却禁止）
- 状態: To Do
- 背景: prelude プラグインの未知シンボルが NULL を返しセグフォを助長していた。
- 対応タスク
    - [ ] 全ビルトインの戻り値経路を監査し、エラーはエラーThunkで統一
    - [ ] 失敗時に SEGV しないことを検証するテストを追加
- 受け入れ条件
    - [ ] 想定外入力でもプロセスが落ちず、エラー表示で回復可能

### CI 強化（安定性/回帰検出）
- 状態: To Do
- 対応タスク
    - [ ] GitHub Actions に GC/非 GC のジョブマトリクスを追加
    - [ ] クラッシュ時の自動バックトレース収集とログ保存
- 受け入れ条件
    - [ ] 回帰が PR で自動検出される

### シェルの `!` ヒストリ展開に関する注意の整備
- 状態: In Progress
- 対応タスク
    - [ ] README と実行手順に安全な呼び出し例を明記（histexpand 無効/クオート/printf 経由など）
- 受け入れ条件
    - [ ] 該当注意がトップレベル README と docs に掲載済み

### nslit デバッグログのドキュメント化
- 状態: To Do
- 背景: `LS_NS_LOG_NSLIT` によるキーバリュの評価トレースを導入済み。
- 対応タスク
    - [ ] 環境変数の説明と使用例を docs に追記（デフォルトはオフ）
- 受け入れ条件
    - [ ] 開発者向けガイドから辿れるようになっている

### nsSelf の廃止
- 状態: To Do
- 目的: 言語機能の簡素化。クロージャ記法で自己参照を表現可能なため。
- 代替例
    ```
    (
        ~List;
        ~List <- {
            .concat <- ...;
            .name   <- ~List concat ...
        };
    )
    ```
    ※ ただし、そもそも上のケースは ｛ .concat <- ...; .name <- ~concat ... ｝ で実装可能
- 影響: 破壊的変更。該当記法の警告期間を設けて段階的に削除する。
- 対応タスク
    - [ ] 字句解析・構文解析・実装から nsSelf を削除
    - [ ] 互換レイヤー/警告を追加し移行ガイドを作成
    - [ ] 試験とドキュメント更新
- 受け入れ条件
    - [ ] nsSelf を用いたコードがビルド時に非推奨警告→期日後エラー
    - [ ] 代替記法で同等機能が確認できる

### `~~N`, `~~"..."`, `~~.sym` の廃止
- 状態: To Do
- 理由: 未使用のため削除して表現系を整理する。
- 対応タスク
    - [ ] トークナイザ/パーサから該当記法を削除
    - [ ] 影響範囲のテスト整備
    - [ ] ドキュメントとサンプル更新
- 受け入れ条件
    - [ ] 該当トークンが入力に含まれる場合は非推奨警告→期日後エラー
    - [ ] 既存テストがすべて通過

### `~~constr` の意味論変更（`~~name` → `~prelude .name`）
- 状態: To Do
- 方針: `~~name` を `~prelude .name` の糖衣に変更。
- 互換性: 破壊的変更の可能性。自動置換ルールと移行ガイドを提供。
- 対応タスク
    - [ ] 意味解析のリライト
    - [ ] コードモッドの提供（`~~x` → `~prelude .x`）
    - [ ] ドキュメント更新と変更点記載
- 受け入れ条件
    - [ ] 旧/新記法の挙動比較テストが合格
    - [ ] コードモッド適用でビルドが通る

### `~~nsdefv`, `~~nsdef` の扱いの見直し
- 状態: Investigate
- 背景: 予約語回避方針とトークン定義が矛盾。
- 調査観点
    - [ ] 実使用箇所・歴史的経緯
    - [ ] 代替手段の有無と移行コスト
- 次のアクション
    - [ ] 維持/名称変更/削除のいずれかを提案
    - [ ] 決定に基づき実装/ドキュメント反映
- 受け入れ条件
    - [ ] 方針決定と合意
    - [ ] 実装とテストが完了

### 束縛演算子の統一（`=` → `<-`）
- 状態: To Do
- 現状: 名前空間リテラルでは `pat <- expr`、クロージャでは `pat = expr`。
- 方針: `pat <- expr` に統一。一定期間は両方許可し、`=` は deprecate。
- 対応タスク
    - [ ] 構文解析で両記法を許容し、`=` 使用時に警告
    - [ ] 実装・標準ライブラリの記法を `<-` に移行
    - [ ] ドキュメント/サンプルの一括置換
- 受け入れ条件
    - [ ] `<-` のみで全テストが通過
    - [ ] `=` 使用時の警告が表示され、期日後エラー化
- 互換性: 段階的移行で破壊的影響を最小化

### 最上位名前空間のビルトインの整理（prelude 経由に統一）
- 状態: To Do
- 背景: 現在 `~add`, `~to_str` などが最上位名前空間に露出している。名前衝突回避と可読性・拡張性のため、prelude 経由での明示アクセスに統一する。
- 方針: すべてのビルトインは `~prelude .name` で公開し、最上位の同名シンボルは非推奨→段階的削除。`~~name` の扱い変更（`~~name` → `~prelude .name`）とも整合させる。
- 互換性: 段階的移行（警告期間→コードモッド提供→期日後エラー化）。
- 対応タスク
    - [ ] prelude に現行ビルトインをエクスポート（命名の正規化）
    - [ ] 最上位のエイリアスに非推奨警告を実装（起点位置と代替を明示）
    - [ ] コードモッド提供（`~name` → `~prelude .name`）
    - [ ] リポジトリ内参照の一括置換と動作確認
    - [ ] ドキュメント/サンプル更新（ガイドライン: ビルトインは prelude 経由）
    - [ ] 回帰テスト追加（旧/新経路の等価性、警告発火の確認）
- 受け入れ条件
    - [ ] `~prelude` 経由のみで全テスト green
    - [ ] 旧最上位エイリアス使用時に警告が出ること
    - [ ] コードモッド適用後にビルド・テストが通る