# LSTR → LLVM IR 変換ルール（ドラフト）

この文書は、LSTR を LLVM IR (text) に落とすための最小ルールを段階的にまとめるラフ仕様です。現時点の実装対象は `src/tools/lstr_to_llvmir.c` です。

## 前提
- 純ADT方針: LSTR 上の代数的データ型 (ALGE) は特別扱いしない。タグ解釈/アンラップは行わない。
- 目的: 最小の値種別から安全に IR を生成し、段階的に拡張する。

## 値の写像
- INT
  - IR: `i32` 即値。
  - 例: ルートが `INT 42` → `define i32 @main() { ret i32 42 }`
- STR
  - IR: グローバル定数とポインタ。
  - `@.str` のような private unnamed_addr の定数に c"...\00" で配置し、GEP で ptr を得る。
  - 例: デモ用途として `puts` 呼出しを挿入（将来フラグでON/OFF）。
- SYMBOL
  - IR: intern 名に基づき、一意な表現を与える。
  - グローバル: `@sym.<label>` にシンボル文字列（先頭 `.` は除去）。
  - 参照: `%sym.<label>` = GEP @sym.* で ptr を得る。
  - ラベル整形: 先頭 `.` を落とし、`[A-Za-z0-9_.]` 以外は `_` に置換。
- ALGE
  - 現状: 不透明。コード生成は行わず安全フォールバック（`ret i32 0`）。
  - 将来: タグ+ペイロードの表現（例: `{ i32 tag; ptr payload }` 等）を別章で提案する。

## 参照と適用
- REF
  - mangle して関数名に変換（例: `fn_<mangled>`）。
  - 0引数呼出しをサポート。
- APPL
  - 当面: 関数が REF、かつ引数がすべて INT の場合に限り、`i32` 引数で宣言/呼出し。
  - 将来: STR/SYMBOL を `ptr` 引数として許容、混在シグネチャにも対応する。

## 比較・論理（将来導入）
- `~~eq` / `~~lt` 等の比較は、定数畳み込み可能な場合のみ IR に落とす方針。
  - INT: `icmp`
  - STR/SYMBOL: 参照等価（ptr eq）または文字列比較（要方針）
- Bool の特別扱いは当面しない。必要性が出た場合のみ i1 写像を採用する。

## 生成の重複排除（将来）
- `@sym.*` / `@.str.*` / `declare` は重複しないよう、簡易レジストリを設ける。

## エラー方針
- 未対応のケースは安全フォールバック（`ret i32 0`）または診断出力。
- 将来、CLI フラグで厳密/寛容モードを切替可能にする。

## 実装の所在
- ツール: `src/tools/lstr_to_llvmir.c`
- 補助: `lstr/`, `thunk/`, `common/str.h` 系の API を使用。

## 変更履歴（抜粋）
- 2025-09-01: 初版。純ADT方針へ切替。SYMBOL の @sym/%sym 追加。ALGE は不透明に。
