# Sprint Backlog (S-2025-08-21 → S-2025-09-04)

スプリント目標
- GC/アロケータ経路の安定化により SEGV を解消し、回避トグル無しで全テストをグリーンに戻す。
- 追加したクォート識別子の仕様をテストとドキュメントで固め、回帰検知を CI に組み込む。

参照
- 90_backlog.md の以下の項目を今スプリント対象とする。
  - GC/アロケータ安定化（nslit × パターンラムダでの SEGV）
  - クォート識別子（'Constr, .'Sym, ~'Var）のテスト/ドキュメント
  - ビルトインの戻り値統一（NULL 返却禁止）
  - CI 強化（安定性/回帰検出）
  - シェルの `!` ヒストリ展開に関する注意の整備
  - nslit デバッグログのドキュメント化

## スコープ（ユーザーストーリー/タスク）

1. [Critical] GC/アロケータ安定化（SEGV解消）
   - [ ] 最小再現テストを追加（GC 有効でのみ落ちるケース）
   - [ ] `common/str.c` の finalizer/削除/再配置ロジックを監査・修正
   - [ ] GC 初期化順の見直し（必要なら `GC_init` の位置調整/削減）
   - [ ] 連続実行・並列実行の耐性チェック（10〜100 連続実行）
   - 受け入れ条件: GC 有効で全テスト green、回避トグル無しで SEGV 再発なし

2. クォート識別子のテスト/ドキュメント
   - [ ] `docs/01_lexing.md` に単引用の構文とエスケープ表を追記
   - [ ] `test/t60_quoted_id_*.ls` 系の新規テスト追加
   - [ ] 競合トークン順配置の回帰テスト（ドット/チルダ/シングルクォート）
   - 受け入れ条件: 新規テスト安定通過、既存構文と矛盾なし

3. ビルトインの戻り値統一（NULL禁止）
   - [ ] 全ビルトインのエラーパスを監査（`NULL` → エラーThunk）
   - [ ] 異常入力時に落ちずにエラーメッセージが出ることを検証するテスト追加
   - 受け入れ条件: 想定外入力でもプロセスが落ちない

4. CI 強化
   - [ ] GitHub Actions に GC/非 GC マトリクス（`LAZYSCRIPT_USE_LIBC_ALLOC=1`）を追加
   - [ ] クラッシュ時のバックトレース/ログ収集を追加
   - 受け入れ条件: PR で回帰が自動検出され、ログが参照できる

5. ドキュメント整備（実行時注意/デバッグ）
   - [ ] README: シェルの `!` ヒストリ展開の注意と安全な呼び出し例を追記
   - [ ] `LS_NS_LOG_NSLIT` の利用方法と出力例を docs に追記
   - 受け入れ条件: トップレベル README と docs から到達可能

## アウト・オブ・スコープ（次スプリント以降）
- `nsSelf` の廃止方針と実装
- `~~*` 記法の段階的廃止とコドモッド
- 束縛演算子の統一（`=` → `<-`）の本実装

## マイルストーン/チェックポイント
- M1: GC 再現テストが追加され赤になる（Day 1–2）
- M2: `common/str.c` 修正で GC 有効でも緑化（Day 3–5）
- M3: クォート識別子テスト/ドキュメント完了（Day 5–7）
- M4: CI マトリクス/クラッシュ収集導入（Day 6–8）
- M5: README/デバッグドキュメント反映（Day 8–9）

## リスクと緩和
- GC 起因の不具合が想定より深い → 回避トグルで運用継続可能、優先度は維持
- CI 導入に時間 → 最低限のマトリクスとログ収集から段階導入

## Definition of Done
- main ブランチで GC 有効・無効の両方で全テスト green
- 新規テストとドキュメントがレビュー済み/リンク済み
- CI が回帰を自動検出し、失敗時の調査が容易
