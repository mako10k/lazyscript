# Sprint Backlog (S-2025-08-21 → S-2025-09-04)

スプリント目標
- [Urgent] 文法の整理を先行し、意図通りの最小で一貫した文法に固定する（後方互換はこのスプリントでは考慮しない）。
- GC/アロケータ経路の安定化により SEGV を解消し、回避トグル無しで全テストをグリーンに戻す。
- 追加したクォート識別子の仕様をテストとドキュメントで固め、回帰検知を CI に組み込む。

参照
- 90_backlog.md の以下の項目を今スプリント対象とする。
   - [緊急] 文法の整理（Moved from Backlog）
   - GC/アロケータ安定化（nslit × パターンラムダでの SEGV）
   - クォート識別子（'Constr, .'Sym, ~'Var）のテスト/ドキュメント
   - ビルトインの戻り値統一（NULL 返却禁止）
   - CI 強化（安定性/回帰検出）
   - シェルの `!` ヒストリ展開に関する注意の整備
   - nslit デバッグログのドキュメント化

## スコープ（ユーザーストーリー/タスク）

0. [Critical/Urgent] 文法の整理（このスプリントは後方互換なし）
    - 仕様固定（docs 反映）
   - [ ] do 記法の意味論（構文はシンプルに `Pat <- Expr;` に統一。例: `!{ ~x <- e1; e2; } ≡ ~~bind e1 (\~x -> e2)`）
   - [ ] 束縛左辺はパターンを許容（既存のパターン束縛ロジックを活用）。ただしパターン内の変数はすべて `~ref`、裸の変数は不可
   - [ ] 関数適用は左結合。括弧削減のガイドを `01_lexing.md`/`02_parsing.md` に追記
   - [ ] prelude は NS 値、引数はドット付きシンボルのみ（例: `(~prelude .println)`）。裸コンストラクタは不可
   - [ ] 名前空間の第1引数はシンボル（`.k`）のみ。裸コンストラクタ/文字列は不可
    - 実装
   - [ ] prelude ディスパッチをドット付きシンボル専用に（裸不可）
       - [ ] do 束縛の左辺検証を強化（parser/semantics）
       - [ ] NS ディスパッチのエラーメッセージ統一とテスト
    - テスト/整形
       - [ ] 既存テストの prelude 呼び出し・左結合スタイルへ整形（括弧削減）
   - [ ] CI に文法スタイルの簡易リンタ（禁則: `(~prelude name)`（裸）, `{ 'K = v; }` など）
    - 受け入れ条件
       - [ ] docs/01_lexing.md, 02_parsing.md, 03_semantics.md, 10_namespaces.md 更新
       - [ ] テスト群が新方針で green（libc/GC）
       - [ ] CI が禁則構文を検出して落とせる

1. [Critical] GC/アロケータ安定化（SEGV解消）
   - [ ] 最小再現テストを追加（GC 有効でのみ落ちるケース）
   - [ ] `common/str.c` の finalizer/削除/再配置ロジックを監査・修正
   - [ ] GC 初期化順の見直し（必要なら `GC_init` の位置調整/削減）
   - [ ] 連続実行・並列実行の耐性チェック（10〜100 連続実行）
   - 受け入れ条件: GC 有効で全テスト green、回避トグル無しで SEGV 再発なし

2. クォート識別子のテスト/ドキュメント
   - [x] `docs/01_lexing.md` に単引用の構文とエスケープ表を追記
   - [x] `test/t60_quoted_id_*.ls` 系の新規テスト追加
   - [x] 競合トークン順配置の回帰テスト（ドット/チルダ/シングルクォート）
   - 受け入れ条件: 新規テスト安定通過、既存構文と矛盾なし

3. ビルトインの戻り値統一（NULL禁止）
   - [ ] 全ビルトインのエラーパスを監査（`NULL` → エラーThunk）
   - [ ] 異常入力時に落ちずにエラーメッセージが出ることを検証するテスト追加
   - 受け入れ条件: 想定外入力でもプロセスが落ちない

4. CI 強化
   - [x] GitHub Actions に GC/非 GC マトリクス（`LAZYSCRIPT_USE_LIBC_ALLOC=1`）を追加
   - [ ] クラッシュ時のバックトレース/ログ収集を追加（gdb バッチ実行と logs/ のアーティファクト化）
   - 受け入れ条件: PR で回帰が自動検出され、ログが参照できる

5. ドキュメント整備（実行時注意/デバッグ）
   - [x] README: シェルの `!` ヒストリ展開の注意と安全な呼び出し例を追記
   - [ ] `LS_NS_LOG_NSLIT` の利用方法と出力例を docs に追記
   - 受け入れ条件: トップレベル README と docs から到達可能

## アウト・オブ・スコープ（次スプリント以降）
- `nsSelf` の廃止方針と実装
- `~~*` 記法の段階的廃止とコドモッド
- 束縛演算子の統一（`=` → `<-`）の本実装（仕様は本スプリントで固定、実装は次）

## マイルストーン/チェックポイント
- M1: GC 再現テストが追加され赤になる（Day 1–2）
- M2: `common/str.c` 修正で GC 有効でも緑化（Day 3–5）
- M3: クォート識別子テスト/ドキュメント完了（Day 5–7）
- M4: CI マトリクス/クラッシュ収集導入（Day 6–8）
- M5: README/デバッグドキュメント反映（Day 8–9）

## リスクと緩和
- GC 起因の不具合が想定より深い → 回避トグルで運用継続可能、優先度は維持
- CI 導入に時間 → 最低限のマトリクスとログ収集から段階導入

## Definition of Done
- main ブランチで GC 有効・無効の両方で全テスト green
- 新規テストとドキュメントがレビュー済み/リンク済み
- CI が回帰を自動検出し、失敗時の調査が容易
