# WIP: 2025-08-21 progress snapshot

目的
- GLR あいまいさ（特に「パターンラムダ × '|' × 適用」）の除去と、プレリュード/API方針（.symbol-only）の貫徹。
- GC/allocator 行の再現 (t63) の安定化に向けた足場づくり。

本日の変更（主要ファイル）
- lib/Option.ls
  - .map/.flatMap/.getOrElse を「値に単一枝ラムダを適用 → 失敗時は右側へ | でフォールバック」スタイルへ書換（ラムダ直近に '|' を置かない方針）。
  - 依然としてパーサの競合が発生（t50 で lib/Option.ls:3.x 範囲にて “syntax is ambiguous”）。
- lib/Result.ls
  - Option と同方針で .map/.flatMap/.withDefault を改修。t51 で同様に曖昧性が残存。
- lib/Ns.ls
  - .nsHas: 存在時 true/非存在時 false を返すよう修正（成功値を (\~_ -> true) で正規化）。
  - .nsGetOr: 既定値フォールバックを適用（(\~v -> ~v) で取り出し | ~d）。
- lib/List.ls
  - nsSelf を用いた相互参照に統一。foldl/foldr/map/filter/append/reverse を整理。
  - .flatMap の括弧を調整（ただし t53 では依然構文エラー報告が継続）。
- test/t63_gc_repro_ns_pm.ls
  - nslit 内 .map を「適用後に | でフォールバック」風に変更し曖昧性を低減する試み。

テスト状況（直近の run-tests 出力要約）
- PASS: 既存多数（t01–t47 の大半、t54–t62 など）、t38 は skip。
- FAIL:
  - t50_option_basic: lib/Option.ls:3.xx “syntax is ambiguous” + requirePure not found 連鎖
  - t51_result_basic: lib/Result.ls:3.xx “syntax is ambiguous”
  - t52_ns_utils: 以前は "true | false"/undefined など（Ns 修正後の再検証は未反映の可能性）
  - t53_list_basic: lib/List.ls:49.xx 付近 “syntax error, unexpected ')'”
  - t63_gc_repro_ns_pm: 依然 “syntax is ambiguous” が残存（位置ずれあり）

所感 / 論点
- 構文規則上、`(\pat -> ...) | (\pat -> ...)` を直近に置いた式や、その直後の適用が GLR の分岐と衝突しやすい。
- 「単一枝ラムダ適用 → | フォールバック」方針でも、`LHS はラムダ適用、RHS は値` 構図が依然曖昧に読まれるケースがあり、さらなる括弧規律 or 中継関数（.match）導入が有力。

次の一手（候補）
- Option/Result に内部ヘルパ `.match` を導入（.map 等は `(\~opt -> (~self .match) ~opt (\..) (\..))` 形式へ）し、`'|'` をラムダ直近に置かない。
- List.flatMap の括弧を最小化し `(~self .foldr) f xs []` の形に統一（現在の余分な括弧を除去）。
- t52 の再検証（Ns 修正反映後の期待出力: `true` と `99`）。
- t63 は nslit 内のローカル束縛 or 関数値化で枝を分け、中継ラムダに適用 → その結果に | でフォールバックの順に固定。

メモ
- プレリュード API は外部公開は .symbol のみ（(~prelude .name)）。
- nslit のメンバーキーは .symbol のみ、かつ後方参照は nsSelf を使用。

このファイル: docs/WIP-2025-08-21.md
