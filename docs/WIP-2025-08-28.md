# WIP — 2025-08-28

このドキュメントは、現在の仕掛（実装中/直近の変更）と次の手（合意済みの次作業）を簡潔に記録します。

## 仕掛（現状）
- caret 式 ^(expr): 専用 AST ノード（LSETYPE_RAISE）を追加し、ランタイムで評価して Bottom を構築。
  - 引数が Bottom の場合は伝播。非 Bottom は `msg="raise: <val>", args=[<val>]` の Bottom に。
  - 仕様反映: `docs/spec/bottom-and-caret.md`, `docs/parser-bnf.md` 更新済み。
- caret パターン ^(pat): Bottom のみマッチ。`^(~x)` は payload（関連引数の先頭）を束縛。WHNF 強制で伝播検知。
- Core IR evaluator (clean/runtime): `match` で no-case の場合、プレースホルダ記号をやめ、Bottom 互換の診断を stderr に出力（unit返し）に統一。
  - 例: `E: <bottom msg="match: no case" at <unknown>:1.1: >`
   - runtime 側は内部表現で実 Bottom（RV_BOTTOM）を返すよう拡張済み（関連: スクルーティニーを1件保持）。
      stdout の値表示も `<bottom msg="..." args=[...]>` に切り替え済み（stderr 診断は従来どおり）。
- prelude 側の暫定 `.raise` を削除。^(expr) は専用 AST/ランタイムのみで動作。
- 既存テストの #err 期待を Bottom 形式へ更新。caret の最小テストを追加。

## 影響
- CLI のエラーメッセージは Bottom 表現で一貫化。
- 一部 Core IR の no-case は「診断出力＋unit」挙動（真の Bottom 生成は後続）。
- prelude に `.raise` が存在しないため、名前依存の呼び出しは不可（仕様どおり）。

## 次の手（合意済み）
1) Core IR の no-case を実 Bottom に昇格
   - clean/runtime evaluator が thunk/trace API から `LSTTYPE_BOTTOM` を構築できるよう拡張。
   - 既存の stderr 診断のみの分岐を削除し、統一的に Bottom を返す（評価系の契約を要確認）。
2) 仕様/ドキュメントの仕上げ
   - Core IR no-case → Bottom（実装完了後）を spec に追記。
3) 追加テスト
   - Core IR の `match` no-case で Bottom を捕捉する回帰テストを追加。
   - caret/Bottom 周辺の境界ケース（args=0 の Bottom 等）。

## コミット対象の主な変更
- ランタイム: `src/thunk/thunk.c`（LSETYPE_RAISE 評価）
- Core IR eval: `src/coreir/coreir_clean.c`, `src/coreir/cir_eval_runtime.c`
- prelude: `src/plugins/builtins_ns.c`（`.raise` 削除）
- 仕様: `docs/spec/bottom-and-caret.md`, `docs/parser-bnf.md`
- テスト: 期待値の Bottom 化と caret の追加 `test/t79_*.{ls,out}`, `test/t80_*.{ls,eval.out}`

## メモ
- 固定識別子禁止の方針に従い、名前ベースの raise は撤廃済み。
- 実装の変更は最小・局所化を維持。repro は `make && ./test/run-tests.sh` で確認可能。
