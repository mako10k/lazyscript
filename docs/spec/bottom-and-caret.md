# Bottom と caret 構文（^(...)）

この文書は、実行時 Bottom 値（エラー情報付きの失敗）と、それに対する構文拡張 `^(...)` の仕様をまとめます。

## 目的
- 例外的状況・パターンマッチ不一致などを、専用の Bottom 値として表現する。
- Bottom は情報（発生位置、メッセージ、関連値群）を保持し、伝播・合成（choice の右成功で破棄、両失敗で併合）できる。
- プログラマが Bottom を捕捉・検査できるよう、パターン `^(pat)` を導入する。
- プログラマが Bottom を構築できるよう、式 `^(expr)` を導入する。

## ランタイム概念
- 実装型: thunk の一種として `Bottom` を持つ（例: `LSTTYPE_BOTTOM`）。
- 保持情報: 位置（loc）、メッセージ（string）、関連引数（thunk の配列）など。
- 伝播原則:
  - 引数が Bottom の関数適用は、全体として Bottom を返す（短絡）。
  - ラムダのパターン不一致は Bottom を返す。
  - choice `a | b` は、`a` が Bottom で `b` が成功なら `b` を返し、両方 Bottom なら情報を併合する。
  - パターンマッチにおける不一致は Bottom を返す（no-match Bottom）。

## caret パターン: `^(pat)`
- 対象: Bottom 値にのみマッチする特別なパターン。
- ふるまい:
  - 入力が Bottom の場合のみ、内側の `<pat>` に対してマッチ処理を行う。
  - `<pat>` がワイルドカード `_` の場合: 成功（値の束縛はなし）。
  - `<pat>` が参照パターン（`~x` 等）の場合: Bottom に関連付けられた引数（payload）に束縛する。
    - 具体的には、現状は Bottom の関連引数の先頭（第1要素）を束縛対象とする。関連引数が0個なら失敗。
    - 将来拡張: 複数引数やメッセージに対する詳細マッチング（TODO）。
  - それ以外の `<pat>` については、現状は失敗（必要に応じて将来拡張）。
- 互換性: ワイルドカード `_` や参照パターンは、非 Bottom 値にはマッチするが、Bottom にはマッチしない（`^(...)` を用いること）。

## caret 式: `^(expr)`
- 目的: 任意のメッセージ・関連引数を持つ Bottom を構築する。
- 現状の実装: 直接 AST ノード（例: `LSETYPE_RAISE`）を生成し、ランタイムで評価時に Bottom を構築する。
  - 評価規則: 引数 `expr` を WHNF まで評価し、すでに Bottom ならそのまま伝播。非 Bottom ならメッセージ `"raise: <expr>"` と関連引数 `[<expr>]` を持つ Bottom を生成する。
  - 注: 一時的な prelude への名前依存デシュガーは撤廃済み。

## 構文（BNF 抜粋）
- efact に `'^' '(' <expr> ')'` を追加。
- pat3 に `'^' '(' <pat> ')'` を追加。
- トークンに `LSTCARET`（`'^'`）を追加。

## 注意点・非互換
- `let` は単一変数束縛のまま維持。`match/case` は Core IR に導入される（別文書参照）。
- `^(...)` の導入により、Bison の衝突カウントが増加している。将来的に文法整理で削減予定。

## 参考
- `docs/parser-bnf.md`
- 実装: `src/parser/parser.y`, `src/pat/*`, `src/thunk/*`, `src/runtime/*`
